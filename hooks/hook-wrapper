#! /usr/bin/env sh
set -e

# Wrapper for run scripts in '<hook-name>.d'
# It is intended that soft linking with this wrapper is good idea

# Find real path. Details on http://stackoverflow.com/a/29835459
rreadlink() ( 
target=$1 fname= targetDir= CDPATH=
{ \unalias command; \unset -f command; } >/dev/null 2>&1 || true
[ -n "$ZSH_VERSION" ] && options[POSIX_BUILTINS]=on 
while :; do 
	[ -L "$target" ] || [ -e "$target" ] || { command printf '%s\n' "ERROR: '$target' does not exist." >&2; return 1; }
	command cd "$(command dirname -- "$target")" 
	fname=$(command basename -- "$target") 
	[ "$fname" = '/' ] && fname='' 
	if [ -L "$fname" ]; then
		target=$(command ls -l "$fname")
		target=${target#* -> }
		continue 
	fi
	break 
done
targetDir=$(command pwd -P) 
if [ "$fname" = '.' ]; then
	command printf '%s\n' "${targetDir%/}"
elif  [ "$fname" = '..' ]; then
	command printf '%s\n' "$(command dirname -- "${targetDir}")"
else
	command printf '%s\n' "${targetDir%/}/$fname"
fi
)

self="$(rreadlink ${0})"
hook="$(dirname -- ${self})/$(basename -- ${0})"
if [ "${self}" = "${hook}" ]; then
	printf "[HOOK-WRAPPER]: %s\n"	"Please, don't run like that!"\
									"Instead, make soft link (named as desired hook) on this script."
	exit 1
fi

printf "[HOOK-WRAPPER]: %s\n" "Begin '$(basename -- ${0})'..."
hook_d="${hook}.d/"
if [ ! -e "${hook_d}" ] || [ ! -d "${hook_d}" ]; then
	printf "[HOOK-WRAPPER]: %s\n"	"Missed '${hook_d}', nothing to do..."
	exit 0
fi

for file in $(find "${hook_d}" -maxdepth 1 -type f -print | sort -n); do
	if [ -s "${file}" ] && [ -x "${file}" ]; then
		printf "[HOOK-WRAPPER]: %s\n" "Running '${file}'..."
		("${file}")
	else
		printf "[HOOK-WRAPPER]: %s\n" "Empty/non-exec '${file}', ignoring..."
		continue
	fi
done
printf "[HOOK-WRAPPER]: %s\n" "Completed '$(basename -- ${0})'."
exit 0
